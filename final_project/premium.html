<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly | Premium Subscription</title>
    <link rel="stylesheet" href="style2.css" />
    <script src="js/appState.js"></script>
    <style>
        /* CRITICAL FIX 1: Ensure entire page and sidebar container fill the height */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* FIX 1: Ensures the main content takes up the full space */
        .premium-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
        }

        .premium-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            /* CRITICAL FIX: Force content to start at the top */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .pricing-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
        }

        .pricing-card.selected {
            border-color: #3498db;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
            transform: translateY(-5px);
        }

        .pricing-card h3 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .price {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2ecc71;
            margin-bottom: 20px;
        }

        .price small {
            font-size: 1rem;
            color: #95a5a6;
            font-weight: 400;
        }

        .features li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            color: #555;
            font-size: 1rem;
            text-align: left;
            padding-left: 10px;
        }

        .features {
            padding: 0;
            margin-bottom: 30px;
        }

        .select-btn {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        .select-btn:hover {
            background: #2980b9;
        }

        /* --- MODAL STYLES (New for Pop-up) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            /* Allow scroll if content is too large */
            padding: 20px;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 95%;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: transparent;
            padding: 5px;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        /* --- Computation Section (Moved inside modal) --- */
        .computation-card h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #2c3e50;
            padding-right: 30px;
            /* Space for close button */
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group select,
        .input-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #f8f8f8;
        }

        .coupon-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .coupon-group input {
            flex-grow: 1;
        }

        .coupon-group button {
            padding: 10px 15px;
            background: #95a5a6;
            color: white;
            font-size: 0.9rem;
            white-space: nowrap;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }


        .summary-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .summary-table th,
        .summary-table td {
            padding: 10px 0;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .summary-table .summary-amount {
            text-align: right;
        }

        .summary-table th {
            font-weight: 600;
            color: #777;
        }

        .summary-table .total-row td {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            border-bottom: none;
            padding-top: 15px;
        }

        .summary-table .total-row .total-amount-display {
            color: #2ecc71;
            text-align: right;
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Weekly</h2>
        </div>
        <nav class="nav-menu">
            <a href="profile.html" class="profile-link">
                <img id="sidebarProfileImg" src="https://i.pravatar.cc/100?img=8" alt="Profile"
                    class="nav-profile-img-large" />
                <span id="sidebarProfileText" class="profile-text">My Profile</span>
            </a>
            <a href="Dashboard.html">Dashboard</a>
            <a href="Members.html">Team Members</a>
            <a href="Projects.html">Projects</a>
            <a href="Gantt.html">Gantt Chart</a>
            <a href="Chat.html">Group Chat</a>
            <a href="Settings.html">Settings</a>
            <a href="Premium.html" class="active">Go Premium</a>
        </nav>
        <div class="signout-container">
            <button class="signout-btn"><a class="signout-btn" href="Login.html">Sign Out</a></button>
        </div>
    </aside>

    <div class="premium-area">
        <main class="premium-content">
            <section class="header-section">
                <h1>Upgrade to a Professional Plan</h1>
                <p>Select the plan that best fits your team's size and operational needs.</p>
            </section>

            <div class="pricing-grid">
                <div class="pricing-card" data-plan="basic" data-price="550.00" data-member-limit="3">
                    <h3>Standard (1-3 Users)</h3>
                    <div class="price">₱550 <small>/ month</small></div>
                    <ul class="features">
                        <li>Maximum of **3** Active Users</li>
                        <li>Unlimited Projects and Tasks</li>
                        <li>Standard Support Services</li>
                        <li>Project Leader Controls</li>
                    </ul>
                    <button class="select-btn" onclick="selectPlan('basic')">Select Standard Plan</button>
                </div>

                <div class="pricing-card" data-plan="pro" data-price="1,100.00" data-member-limit="6">
                    <h3>Professional (4-6 Users)</h3>
                    <div class="price">₱1,100 <small>/ month</small></div>
                    <ul class="features">
                        <li>Maximum of **6** Active Users</li>
                        <li>Advanced Reporting Tools</li>
                        <li>Priority Technical Support</li>
                        <li>Integration Capabilities (API)</li>
                    </ul>
                    <button class="select-btn" onclick="selectPlan('pro')">Select Professional Plan</button>
                </div>

                <div class="pricing-card" data-plan="enterprise" data-price="2,750.00" data-member-limit="999">
                    <h3>Enterprise (Unlimited Users)</h3>
                    <div class="price">₱2,750 <small>/ month</small></div>
                    <ul class="features">
                        <li>**Unlimited** Active Users</li>
                        <li>Dedicated Account Manager</li>
                        <li>Customizable Security Protocols</li>
                        <li>Onboarding and Training Services</li>
                    </ul>
                    <button class="select-btn" onclick="selectPlan('enterprise')">Select Enterprise Plan</button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>

            <div id="computationCard">
                <h3>Payment Summary & Checkout</h3>

                <div class="input-group">
                    <label for="memberCountSelect">Total Active Users (Including Leader):</label>
                    <select id="memberCountSelect">
                    </select>
                </div>

                <div class="input-group">
                    <label for="couponCode">Discount Code:</label>
                    <div class="coupon-group">
                        <input type="text" id="couponCode" placeholder="Enter coupon code (e.g., WELCOME10)">
                        <button id="applyCouponBtn">Apply</button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="paymentMethodSelect">Payment Method:</label>
                    <select id="paymentMethodSelect">
                        <option value="credit">Credit/Debit Card</option>
                        <option value="paypal">PayPal / Gcash</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>


                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align: right;">Amount (PHP)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Plan: <span id="summaryPlanName"></span> (<span id="summaryMemberLimit"></span>)</td>
                            <td class="summary-amount">₱<span id="summaryBasePrice">0.00</span></td>
                        </tr>
                        <tr>
                            <td>VAT (12%)</td>
                            <td class="summary-amount">₱<span id="summaryVAT">0.00</span></td>
                        </tr>
                        <tr id="discountRow" style="display: none;">
                            <td>Discount (<span id="discountPercent">10%</span>)</td>
                            <td class="summary-amount" style="color: #e74c3c;">- ₱<span id="summaryDiscount">0.00</span>
                            </td>
                        </tr>
                        <tr class="total-row">
                            <td>Total Amount Due Monthly</td>
                            <td class="total-amount-display">₱<span id="summaryTotal">0.00</span></td>
                        </tr>
                    </tbody>
                </table>

                <button class="select-btn" style="margin-top: 25px; background: #2ecc71;">Finalize Subscription</button>
            </div>
        </div>
    </div>


    <script>
        initializeDemoData();

        // --- Pricing Data (All prices in PHP) ---
        const PRICING_PLANS = {
            // Price converted to a number for calculation
            'basic': { name: 'Standard', price: 550.00, limit: 3 },
            'pro': { name: 'Professional', price: 1100.00, limit: 6 },
            'enterprise': { name: 'Enterprise', price: 2750.00, limit: 999 }
        };
        const VAT_RATE = 0.12;
        const COUPON_CODE = 'WELCOME10';
        const DISCOUNT_PERCENT = 0.10; // 10%

        // --- DOM Elements ---
        // Changed to reference the modal overlay
        const modalOverlay = document.getElementById('modalOverlay');
        const memberCountSelect = document.getElementById('memberCountSelect');
        const pricingCards = document.querySelectorAll('.pricing-card');
        const couponCodeInput = document.getElementById('couponCode');
        const applyCouponBtn = document.getElementById('applyCouponBtn');
        const discountRow = document.getElementById('discountRow');

        // --- State Variables ---
        let selectedPlanKey = null;
        let selectedMemberCount = 1;
        let isCouponApplied = false;

        // --- Initialization and Utility Functions ---

        function updateSidebarProfile() {
            // ... (Your existing profile update logic)
            const currentUser = loadData('currentUser');
            const sidebarProfileImg = document.getElementById('sidebarProfileImg');
            const sidebarProfileText = document.getElementById('sidebarProfileText');
            const DEFAULT_AVATAR = "https://i.pravatar.cc/100?img=8";

            if (currentUser && sidebarProfileImg && sidebarProfileText) {
                const avatarSource = currentUser.avatarUrl || DEFAULT_AVATAR;
                sidebarProfileImg.src = avatarSource;
                sidebarProfileText.textContent = currentUser.name;
            }
        }

        function populateMemberCountSelect() {
            const maxMembers = 15; // Set a realistic max for the dropdown
            for (let i = 1; i <= maxMembers; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i} Active User${i > 1 ? 's' : ''}`;
                memberCountSelect.appendChild(option);
            }
            selectedMemberCount = 1;
            memberCountSelect.value = selectedMemberCount;
        }

        // Helper to format currency (PHP)
        function formatCurrency(amount) {
            // Use toLocaleString for proper comma separation and fixed decimals
            return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }


        // Core computation and display function
        function updateSummary() {
            const plan = selectedPlanKey ? PRICING_PLANS[selectedPlanKey] : null;

            if (!plan) return;

            const summaryTotalElement = document.getElementById('summaryTotal');
            const totalRow = summaryTotalElement.closest('.total-row');
            const checkoutButton = document.querySelector('.modal-content .select-btn');
            const computationCard = document.getElementById('computationCard'); // Now inside the modal

            // 1. Check for member limit violation
            if (selectedMemberCount > plan.limit) {
                // If member count exceeds the limit, display an error and force upgrade
                computationCard.style.border = '2px solid #e74c3c';
                summaryTotalElement.textContent = 'UPGRADE REQUIRED';
                totalRow.querySelector('.total-amount-display').style.color = "#e74c3c";
                checkoutButton.disabled = true;

                // Still update plan details for context
                document.getElementById('summaryPlanName').textContent = plan.name;
                document.getElementById('summaryMemberLimit').textContent = `Max ${plan.limit} Users`;
                document.getElementById('summaryBasePrice').textContent = formatCurrency(plan.price);
                document.getElementById('summaryVAT').textContent = '0.00';
                document.getElementById('summaryDiscount').textContent = '0.00';
                discountRow.style.display = 'none';

                return;
            } else {
                computationCard.style.border = 'none';
                checkoutButton.disabled = false;
                totalRow.querySelector('.total-amount-display').style.color = "#2ecc71";
            }

            // 2. Base Price and VAT Calculation
            let basePrice = plan.price;
            const vatAmount = basePrice * VAT_RATE;
            let subtotal = basePrice + vatAmount;
            let discountAmount = 0;

            // 3. Discount Calculation
            if (isCouponApplied) {
                discountAmount = basePrice * DISCOUNT_PERCENT;
                subtotal -= discountAmount;
                discountRow.style.display = '';
                document.getElementById('discountPercent').textContent = `${(DISCOUNT_PERCENT * 100).toFixed(0)}%`;
                document.getElementById('summaryDiscount').textContent = formatCurrency(discountAmount);
            } else {
                discountRow.style.display = 'none';
            }

            // 4. Update Summary Table
            document.getElementById('summaryPlanName').textContent = plan.name;
            document.getElementById('summaryMemberLimit').textContent = `Max ${plan.limit} Users`;
            document.getElementById('summaryBasePrice').textContent = formatCurrency(basePrice);
            document.getElementById('summaryVAT').textContent = formatCurrency(vatAmount);
            summaryTotalElement.textContent = formatCurrency(subtotal);
        }

        // Function to close the modal
        window.closeModal = () => {
            modalOverlay.style.display = 'none';
        };

        // Handles plan selection
        window.selectPlan = (planKey) => {
            selectedPlanKey = planKey;

            pricingCards.forEach(card => {
                if (card.getAttribute('data-plan') === planKey) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // Show the modal pop-up
            modalOverlay.style.display = 'flex';
            updateSummary();
        };

        // Handles member count change
        memberCountSelect.addEventListener('change', (e) => {
            selectedMemberCount = parseInt(e.target.value);
            updateSummary();
        });

        // Apply Coupon Logic
        applyCouponBtn.addEventListener('click', () => {
            const enteredCode = couponCodeInput.value.toUpperCase().trim();

            if (enteredCode === COUPON_CODE) {
                isCouponApplied = true;
                applyCouponBtn.textContent = "Applied!";
                applyCouponBtn.style.background = "#2ecc71";
                couponCodeInput.disabled = true;
                alert(`Coupon applied: ${(DISCOUNT_PERCENT * 100)}% discount on base price.`);
            } else {
                isCouponApplied = false;
                applyCouponBtn.textContent = "Apply";
                applyCouponBtn.style.background = "#95a5a6";
                couponCodeInput.disabled = false;
                alert("Invalid or expired coupon code.");
            }
            updateSummary();
        });

        // Close modal if user clicks outside the content area
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });


        // --- Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            updateSidebarProfile();
            populateMemberCountSelect();
        });

        // Real-time update listener for profile sync
        window.addEventListener('storage', (e) => {
            if (e.key === 'currentUser' || e.key === 'userRole' || e.key === null) {
                updateSidebarProfile();
            }
        });
    </script>
</body>

</html>